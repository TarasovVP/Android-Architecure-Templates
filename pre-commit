#!/bin/sh

CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.kts\?$')
KOTLIN_FILES=$(echo "$CHANGED_FILES" | grep '\.kt$')

if [ -n "$CHANGED_FILES" ]; then
  echo "ğŸ” Found changed Kotlin files:"
  echo "$CHANGED_FILES"

  echo "ğŸ›   Running ktlintFormat..."
  echo "$CHANGED_FILES" | xargs ./gradlew ktlintFormat -Pincludes=

  echo "â• Adding formatted files to commit..."
  echo "$CHANGED_FILES" | xargs git add

  echo "ğŸ” Running ktlintCheck..."
  ./gradlew ktlintCheck
  if [ $? -ne 0 ]; then
    echo "âŒ Ktlint check failed! Please fix the errors and try again."
    exit 1
  fi

  echo "ğŸ” Running detekt..."
    ./gradlew detekt
    DETEKT_EXIT_CODE=$?
    if [ $DETEKT_EXIT_CODE -ne 0 ]; then
      echo "âŒ Detekt check failed! Please fix the issues and try again."
      exit 1
    fi

else
  echo "â„¹ï¸ No changed Kotlin files to check."
fi

exit 0
