#!/bin/sh

CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.kts\?$')
DETEKT_TARGETS=$(echo "$CHANGED_FILES" | grep '\.kt$' | tr '\n' ',' | sed 's/,$//')

if [ -n "$CHANGED_FILES" ]; then
  echo "üîç Found changed Kotlin files:"
  echo "$CHANGED_FILES"

  echo "üõ†  Running ktlintFormat..."
  echo "$CHANGED_FILES" | xargs ./gradlew ktlintFormat -Pincludes=

  echo "‚ûï Adding formatted files to commit..."
  echo "$CHANGED_FILES" | xargs git add

  echo "üîé Running ktlintCheck..."
  ./gradlew ktlintCheck
  if [ $? -ne 0 ]; then
    echo "‚ùå Ktlint check failed! Please fix the errors and try again."
    exit 1
  fi

  if [ -n "$DETEKT_TARGETS" ]; then
    echo "üîé Running detekt on changed files..."
    ./gradlew detekt --detekt-input "$DETEKT_TARGETS"
    if [ $? -ne 0 ]; then
      echo "‚ùå Detekt check failed! Please fix the issues and try again."
      exit 1
    fi
  else
    echo "‚ÑπÔ∏è No .kt files to check with Detekt."
  fi
else
  echo "‚ÑπÔ∏è No changed Kotlin files to check."
fi

exit 0
